# AutoWriter Enhanced 系统设计文档

## 概述

AutoWriter Enhanced 是一个基于多Agent协作的智能报告生成系统，专门用于生成高质量的绩效评价报告。系统采用**虚拟办公环境**的设计理念，通过模拟真实办公室的岗位分工来实现人机协同的报告写作。

## 核心理念

### 1. 虚拟办公环境架构
系统设计完全基于真实办公室的工作模式，每个Agent对应一个具体的办公室岗位：

- **🎯 智能项目总监**：相当于项目经理，负责整体规划、任务分配和客户沟通
- **📄 文档专家（李心悦）**：相当于办公室文秘，负责所有文档的管理、归档、格式化和摘要
- **🔍 案例专家（王磊）**：相当于研究员，负责搜索相关案例和最佳实践
- **📊 数据分析师（赵丽娅）**：负责数据收集、统计分析和图表制作
- **✍️ 写作专家（张翰）**：负责报告的撰写和内容创作
- **👔 总编辑（钱敏）**：负责最终的质量审核、润色和把关

### 2. 文档处理工作流
**文档专家（李心悦）的核心职责**：
- 接收所有客户上传的文档（相当于文件柜管理）
- 使用MinerU API将各种格式文档转换为Markdown
- 对文档进行索引、分类、摘要和关键信息提取
- 为其他Agent提供格式化的文档内容

**工作流程**：
```
客户上传文档 → 项目总监接收 → 转交给文档专家李心悦 → 
李心悦调用MinerU API处理 → 格式化为Markdown → 
索引和摘要 → 通知项目总监"文档已处理完成"
```

### 3. 人机协同模式
- **项目总监**始终与客户保持沟通，根据需求协调团队工作
- 客户可以随时上传资料、提出修改要求或调整方向
- 每个Agent都有明确的职责边界，避免工作重叠

## 技术架构

### 核心基础设施（稳定层）
这些文件构成系统的核心基础设施，一旦稳定后不应频繁修改：

```
backend/services/
├── core_manager.py          # 核心管理器 - Agent团队协调
├── llm_provider.py          # LLM提供者 - 统一的AI接口
└── websocket_manager.py     # WebSocket管理器 - 实时通信
```

### Agent层（扩展层）
这些文件可以独立开发和扩展，不影响核心基础设施：

```
backend/services/llm/agents/
├── base.py                  # 基础Agent类
├── director.py              # 智能项目总监
├── document_expert.py       # 文档专家（李心悦）
├── case_expert.py           # 案例专家（王磊）
├── data_analyst.py          # 数据分析师（赵丽娅）
├── writer_expert.py         # 写作专家（张翰）
└── chief_editor.py          # 总编辑（钱敏）
```

### 工具层（功能层）
专业工具，为Agent提供具体功能：

```
backend/tools/
├── alibaba_search.py        # 阿里巴巴搜索工具
└── mineru_api_tool.py       # MinerU文档处理API
```

## Agent详细设计

### 📄 文档专家（李心悦）
**角色定位**：办公室文秘，文档管理专家

**核心职责**：
- 文档接收和存储管理
- 多格式文档转换（PDF、Word、Excel等 → Markdown）
- 文档索引和分类
- 关键信息提取和摘要
- 为其他Agent提供格式化内容

**工作空间结构**：
```
workspaces/{session_id}/document_expert/
├── uploads/                 # 原始上传文件
├── processed/               # 处理后的Markdown文件
├── summaries/               # 文档摘要
└── index.json              # 文档索引
```

**核心方法**：
- `process_uploaded_file()` - 处理上传的文件
- `convert_to_markdown()` - 调用MinerU API转换格式
- `extract_key_info()` - 提取关键信息
- `create_summary()` - 生成文档摘要
- `update_index()` - 更新文档索引

### 🎯 智能项目总监
**角色定位**：项目经理，客户沟通和团队协调

**核心职责**：
- 与客户进行需求沟通
- 动态生成报告模板
- 协调各专家Agent工作
- 质量把控和进度管理

### 🔍 案例专家（王磊）
**角色定位**：研究员，案例搜索和分析

**核心职责**：
- 搜索相关案例和最佳实践
- 分析行业标杆
- 提供参考资料

### 📊 数据分析师（赵丽娅）
**角色定位**：数据专家，统计分析

**核心职责**：
- 数据收集和整理
- 统计分析和计算
- 图表制作和可视化

### ✍️ 写作专家（张翰）
**角色定位**：内容创作者，报告撰写

**核心职责**：
- 根据分析结果撰写报告
- 内容组织和结构化
- 语言润色和优化

### 👔 总编辑（钱敏）
**角色定位**：质量把关，最终审核

**核心职责**：
- 内容质量审核
- 格式规范检查
- 最终润色和定稿

## 工作流程设计

### 典型工作流程
1. **客户发起需求** → 项目总监接收并分析
2. **需求澄清** → 项目总监与客户对话，明确具体要求
3. **文档处理** → 客户上传资料，李心悦处理并格式化
4. **任务分配** → 项目总监根据需求分配具体任务
5. **并行工作** → 各专家Agent同时开展工作
6. **内容整合** → 张翰整合各方面内容撰写报告
7. **质量审核** → 钱敏进行最终审核和润色
8. **客户反馈** → 项目总监收集反馈，协调修改

### 文档处理专项流程
```
客户上传文档 
    ↓
项目总监："李心悦，请处理这个文档"
    ↓
李心悦接收文档到 uploads/ 目录
    ↓
调用 MinerU API 转换为 Markdown
    ↓
保存到 processed/ 目录
    ↓
提取关键信息，生成摘要
    ↓
更新文档索引
    ↓
通知项目总监："XX文档已处理完成，可以使用"
```

## 前端界面设计

### 三面板布局
- **左侧聊天区域（35%）**：与项目总监对话
- **右侧Agent工作面板（65%）**：实时观察各Agent工作状态

### Agent状态展示
每个Agent都有独立的工作区域，显示：
- 当前工作状态
- 工作进度
- 产出文件
- 工作日志

## 数据流设计

### WebSocket消息类型
```typescript
interface AgentMessage {
  type: 'agent_message';
  agent_type: string;        // 'document_expert', 'case_expert', etc.
  agent_name: string;        // '李心悦', '王磊', etc.
  content: string;           // 消息内容
  status: string;            // 'working', 'completed', 'error'
  timestamp: string;
}
```

### 工作空间结构
```
workspaces/{session_id}/
├── document_expert/         # 李心悦的工作区
│   ├── uploads/            # 原始文件
│   ├── processed/          # 处理后文件
│   └── summaries/          # 摘要文件
├── case_expert/            # 王磊的工作区
├── data_analyst/           # 赵丽娅的工作区
├── writer_expert/          # 张翰的工作区
├── chief_editor/           # 钱敏的工作区
└── final_report.md         # 最终报告
```

## 扩展性设计

### 新增Agent的步骤
1. 在 `backend/services/llm/agents/` 创建新的Agent类
2. 继承 `BaseAgent` 类
3. 实现具体的 `execute_task()` 方法
4. 在 `core_manager.py` 的 `AGENT_TEAM_CONFIG` 中注册
5. 前端添加对应的显示组件

### 新增工具的步骤
1. 在 `backend/tools/` 创建新的工具文件
2. 实现统一的工具接口
3. 在相应的Agent中引用和使用

## 部署和配置

### 环境要求
- Python 3.8+
- Node.js 16+
- MetaGPT框架
- MinerU API密钥

### 配置文件
- `MetaGPT/config/config2.yaml` - MetaGPT配置
- 环境变量中配置MinerU API密钥

## 总结

这个虚拟办公环境的设计理念使得：
1. **代码结构清晰**：每个Agent对应现实中的具体岗位
2. **职责边界明确**：避免功能重叠和混乱
3. **易于理解和维护**：新开发者可以快速理解系统架构
4. **扩展性强**：可以轻松添加新的"员工"（Agent）
5. **核心稳定**：基础设施层稳定后，只需要完善各个Agent的具体实现

通过这种设计，我们创建了一个真正意义上的"AI办公室"，每个AI员工都有自己的专业领域和工作空间，协同完成复杂的报告写作任务。

## 重要Agent黄金设计法则

### Agent能力架构：私有能力与公共工具

为了实现真正的智能与可扩展性，Agent的能力被划分为两个层次：

1.  **私有能力 (Private Skills)**:
    -   **定义**: 这是智能体与生俱来的、定义其核心角色的**专有技艺**。例如，`WriterExpert`的核心是“写作”这一创造性过程。
    -   **实现**: 通常作为Agent类内部的一个私有方法 (`_private_method`) 或一个与Agent紧密耦合的`Action`。它代表了该Agent不可替代的价值。

2.  **公共工具 (Public Tools)**:
    -   **定义**: 这是团队的**“公共装备库”**，提供标准化的、可被多个专家“租用”的原子能力。例如，“总结文本”、“润色语言”、“创建报告大纲”等。
    -   **实现**: 作为独立的`Action`子类或函数，存放在`backend/tools/`目录下。
    -   **声明与使用**: Agent通过在其`__init__`构造函数中调用`self.set_actions([...])`来声明它所“租用”的工具集。

### 智能决策机制：从关键词匹配到React模式

Agent如何智能地使用它的能力集？我们摒弃了落后的`if/elif`关键词匹配，采用`MetaGPT`框架提供的先进`React`模式：

-   **`_set_react_mode(react_mode=RoleReactMode.REACT)`**: Agent被设置为`REACT`模式后，其`_act`方法将获得智能决策能力。
-   **工作原理**: 当接到任务时，Agent会将**任务描述**和它的**能力清单(actions)**打包，通过LLM进行一次“思考”。LLM会根据任务意图，从能力清单中选择最合适的`Action`来执行。
-   **优势**: 这使得Agent的行为真正由**对任务的理解**来驱动，而不是死板的关键词。`_execute_specific_task`这类复杂的路由方法将被彻底弃用，由框架的`React`逻辑接管，极大地提升了智能性和代码的简洁性。


### 📄 文档专家（李心悦）
**角色定位**：办公室文秘，文档管理专家

**核心职责**：
# ... existing code ...